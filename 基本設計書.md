# 基本設計書: オンラインゲームNPC自然会話用ローカルLLM

## 1. 目的と範囲
- 目的: 要件定義に基づき、NPCが自然対話し、会話に応じたゲーム状態更新のための関数呼び出し案（structured actions）を返すローカルLLMシステムの基本設計を定義する。
- 範囲: コンポーネント構成、API/I/F、データモデル、シーケンス、プロンプト/推論設計、セキュリティ、観測性、評価基盤、設定/運用。

## 2. 全体アーキテクチャ
- コンポーネント
  - Inference Runner: LLM推論（llama.cpp/ExLlamaV2/vLLMのいずれか）。
  - Conversation Manager: 会話履歴管理、要約、ペルソナ適用、短期記憶。
  - Memory/RAG: 世界観/API仕様の検索補助（簡易ベクタストア/FAISS）。
  - Tooling Manager: 利用可能関数スキーマ配信、生成出力のスキーマ検証/修復。
  - Confidence Router: 低コストモデル→低信頼時フォールバック（7B→14B等）。
  - Validator/Sandbox: 実行前の静的検査、I/O制限、承認フローの付帯情報生成。
  - Game Engine Adapter(API): HTTP/gRPC I/F（初期はHTTP/JSON）。
  - Evaluator: 自動/人手評価、ログ/メトリクス集計、可視化（CLI/Notebook）。

- デプロイ想定
  - ローカルマシン/GPUワークステーション。オフライン運用可能。
  - サービス構成: 単一プロセス（FastAPI）＋バックグラウンド推論ワーカー。

## 3. ディレクトリ構成（案）
- `app/`
  - `api/`（FastAPIルータ: chat, propose_action, schema）
  - `core/`（config, logging, metrics, utils）
  - `llm/`（runners: llama_cpp, exllama_v2, transformers; router）
  - `memory/`（history, summarizer, vectorstore）
  - `tooling/`（function_registry, schema_validator, action_builder）
  - `security/`（sandbox, io_policies, pii）
  - `evaluator/`（metrics_calc, scenarios）
  - `prompts/`（system, fewshot, repair）
- `configs/`（YAML: model, sampling, router, security, paths）
- `review/`（評価/参考資料）

## 4. API設計
- 共通
  - ベース: HTTP/JSON、UTF-8、`application/json`。
  - エラーフォーマット: `{ "error": { "code": string, "message": string, "details"?: object } }`。

- `POST /chat`
  - Req: `{ "session_id": string, "input": string, "state"?: object, "options"?: {"temperature"?: number, "max_tokens"?: number} }`
  - Res: `{ "reply": string, "structured_actions": StructuredActions, "meta": {"model": string, "latency_ms": number, "confidence": number} }`

- `POST /propose_action`
  - Req: `{ "session_id": string, "input": string, "state": object, "tools"?: string[] }`
  - Res: `{ "actions": StructuredActions["actions"], "explanations"?: string[], "meta": {"model": string, "latency_ms": number, "confidence": number} }`

- `GET /schema/functions`
  - Res: `{ "functions": FunctionRegistry["functions"], "version": string }`

- 将来: gRPC版（双方向ストリーミング）/WebSocket（ストリーミング出力）

## 5. データモデル
- StructuredActions（要件定義14.1を継承）
```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "StructuredActions",
  "type": "object",
  "properties": {
    "actions": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["function", "arguments"],
        "properties": {
          "function": {"type": "string"},
          "arguments": {"type": "object"},
          "confidence": {"type": "number", "minimum": 0, "maximum": 1},
          "rationale": {"type": "string"},
          "risk": {"type": "string", "enum": ["low", "medium", "high"]}
        }
      }
    }
  },
  "required": ["actions"]
}
```

- FunctionRegistry（関数リスト）
```json
{
  "functions": [
    {
      "name": "npc_follow_player",
      "description": "NPCがプレイヤーの後を追う",
      "parameters": {
        "type": "object",
        "required": ["npc_id", "player_id"],
        "properties": {
          "npc_id": {"type": "string"},
          "player_id": {"type": "string"},
          "speed": {"type": "string", "enum": ["walk", "run"], "default": "walk"}
        }
      },
      "risk": "low"
    }
  ],
  "version": "v1"
}
```

- ConversationLog（JSON Lines）
```json
{"ts":"2025-01-01T12:00:00Z","session_id":"s1","turn":1,"role":"user","text":"入口はどこ？"}
{"ts":"2025-01-01T12:00:00Z","session_id":"s1","turn":1,"role":"assistant","text":"こちらです。","json_valid":true,"latency_ms":620,"model":"qwen2.5-7b-gptq-4bit-exl2"}
```

## 6. シーケンス（代表）
- Chat + Action提案（Confidence Routerあり）
  1) APIが入出力を受理、会話履歴・世界状態を集約
  2) Memory/RAGが関連知識を検索→プロンプト組立
  3) Routerが低コストモデル（例: 7B-4bit）で推論開始（ストリーミング）
  4) 出力ストリームをGrammar/JSON Schemaで逐次検証、逸脱時は修復/再サンプル
  5) 構造出力・ツール適合率・自己検証で信頼度を算出
  6) 低信頼なら上位モデルへフォールバック→再生成
  7) Validatorがスキーマ/引数/権限を検証→応答返却

## 7. プロンプト/推論設計
- システムプロンプト
  - NPCの役割/口調/禁則、世界観遵守、出力規約（JSON厳格、回答部とactions分離）。
- Few-shot
  - 関数提案の成功例/失敗例/自己チェック例を最小3件提示。
- 推論パラメータ
  - `temperature`, `top_p`, `repetition_penalty`, `max_new_tokens`。
  - JSON出力時: `temperature`低め、`min_p`/`top_p`で安定化。
- 出力拘束
  - llama.cpp grammar/Outlines相当でJSON/関数出力を拘束。
  - インクリメンタル検証（ストリーミング）＋自己修復プロンプト。

## 8. モデル/ランタイム/量子化
- 初期推奨
  - GPU: 7B GPTQ-4bit + ExLlamaV2 実装。CPU/軽GPU: GGUF q4_K_M + llama.cpp。
- 切替方針
  - `configs/model.yaml`で`runner`（llama_cpp/exllama_v2/transformers）と重み/量子化を選択。
- 最適化
  - FlashAttention/SDPA、KVキャッシュ、prefill/decoding分離、バッチ/beamの適用。

## 9. Memory/RAG設計
- 短期記憶: 会話履歴からの要約（最新K発話＋要約トークン）。
- 長期/外部: 世界観/API仕様をベクタ化し、クエリで上位k件を投入。
- ベクタストア: FAISS（ローカル、オフライン可）。

## 10. Tooling/Validator設計
- FunctionRegistry: ゲーム側から投入（ホワイトリスト）。
- SchemaValidator: StructuredActions/関数引数のバリデーション。
- Risk/Policy: 変更系関数は追加承認フラグを付与。
- SSRF/IO制限: URLスキーム/ホストの検証、外部I/Oは既定拒否。

## 11. セキュリティ設計
- サンドボックス: 生成コードは自動実行しない。別プロセス/権限最小の検証器のみ。
- 権限分離: 読み取り系/状態変更系のI/Fを分離し監査ログを付与。
- モデル完全性: 重み/トークナイザのSHA256ハッシュ検証、由来ログ保持。

## 12. 観測性/メトリクス
- 収集: レイテンシ（P50/P95）、トークン/秒（prefill/decoding）、メモリ/VRAM、JSON妥当性、ツール正確性、幻覚率。
- ログ: JSON Lines。必須フィールド（モデルID/量子化/コミットID/seed/設定）。
- ダッシュボード: 初期はNotebook/CLIで可視化、必要に応じてWeb UI。

## 13. 評価設計
- 指標: ツール正確性、JSON妥当性、目標達成率、レイテンシ、幻覚率、人手評価。
- 受入基準（Exit Criteria）: 要件定義のM1–M4基準に準拠。
- ストレス/対逆攻: Prompt Injection/ノイズ/未定義関数誘導。
- カスケード比較: 7B単独 vs 7B→14Bの品質/コスト/レイテンシ比較。

## 14. エラー処理/リトライ方針
- JSON不整合: 出力修復プロンプト→再サンプル（N回）→フォールバック。
- 未定義関数: リジェクト＋代替案提示（候補関数の近似一致）。
- タイムアウト: ストリーミング監視、段階的キャンセルと簡易応答返却。

## 15. 設定/運用
- `configs/model.yaml`（例）
```yaml
runner: exllama_v2
model_id: qwen2.5-7b-gptq-4bit-exl2
context_length: 32768
sampling:
  temperature: 0.6
  top_p: 0.9
router:
  primary: qwen2.5-7b-gptq-4bit-exl2
  fallback: llama-3.1-8b-instruct-gguf-q4_k_m
  confidence_threshold: 0.78
security:
  allow_network: false
  allowed_hosts: []
```
- 実行: `uvicorn app.main:app --host 0.0.0.0 --port 8000`
- devcontainer: Python 3.10+/CUDA/torch/llama-cpp-python/bitsandbytes 追加。

## 16. マイルストーンとの対応
- M1: API雛形、7B量子化、JSON拘束出力、手動評価の最低限。
- M2: 自動評価・ストレス評価・可視化、Energy/Cost測定組込。
- M3: LoRA/RAG/量子化/プロンプト比較・レポート。
- M4: セキュリティ検証（SSRF/権限分離/サンドボックス）合格。

## 17. 実行スクリプト例
- `scripts/run_server.py`: FastAPIサーバ起動。`configs/model.yaml`/`configs/security.yaml`を読み込み、Router/Runnerを構成して`/chat`と`/propose_action`を提供。
  - 例: `python scripts/run_server.py --host 0.0.0.0 --port 8000`
- `scripts/chat_cli.py`: ローカル対話CLI（ストリーミング＋JSON整形式検証）。ペルソナ/関数スキーマを指定可能。
  - 例: `python scripts/chat_cli.py --session s1 --functions configs/functions.json "宿屋はどこ？"`
- `scripts/bench_eval.py`: KPI一括計測（ツール正確性/JSON妥当性/レイテンシ/トークン毎秒）。
  - 例: `python scripts/bench_eval.py --scenarios data/scenarios/*.jsonl --out reports/bench.csv`
- `scripts/adversarial_test.py`: Prompt injection/ノイズ/未定義関数誘導の耐性テスト。
  - 例: `python scripts/adversarial_test.py --cases data/adversarial/*.json --retries 2`
- `scripts/router_sweep.py`: Confidence閾値・温度・n-bestの探索。7B単独 vs フォールバックの比較。
  - 例: `python scripts/router_sweep.py --grid configs/sweeps/router.yaml`
- `scripts/replay_session.py`: セッションJSONLの再生（seed固定）で再現性確認。
  - 例: `python scripts/replay_session.py --log runs/s1.jsonl`
- `scripts/build_index.py`: 世界観/API仕様のベクタ索引構築（FAISS）。
  - 例: `python scripts/build_index.py --src data/knowledge --out artifacts/index.faiss`
- `scripts/gen_synthetic_actions.py`: 関数呼び出し合成データ生成（few-shot+ルール）。
  - 例: `python scripts/gen_synthetic_actions.py --functions configs/functions.json --out data/synthetic.jsonl`
- `scripts/validate_actions.py`: structured_actionsをJSON Schema＋関数定義で検証、危険度/承認要否を付与。
  - 例: `python scripts/validate_actions.py --in runs/output.jsonl --functions configs/functions.json`
- `scripts/io_policy_check.py`: ツール引数のURL/パスをSSRF/I/Oポリシで静的検査。
  - 例: `python scripts/io_policy_check.py --in runs/actions.jsonl --policy configs/security.yaml`
- `scripts/measure_power.py`: レイテンシ/トークン毎秒/電力を同時計測し、1トークン当たりコストを算出。
  - 例: `python scripts/measure_power.py --duration 60 --model qwen2.5-7b-gptq-4bit-exl2`
- `scripts/verify_artifacts.py`: モデル/トークナイザ/量子化重みのSHA256検証と由来ログ出力。
  - 例: `python scripts/verify_artifacts.py --manifest configs/artifacts.yaml`
- `scripts/convert_quant.py`: 量子化/形式変換（HF→GGUF、GPTQ/AWQメタ生成）ヘルパ。
  - 例: `python scripts/convert_quant.py --src models/qwen2.5-7b --to gguf --bits 4`
- `scripts/log_summary.py`: JSONLログからメトリクス集計（P50/P95、JSON妥当性率、ツール正確性）。
  - 例: `python scripts/log_summary.py --logs runs/*.jsonl --out reports/summary.csv`
- `scripts/train_lora.py`: 小規模SFT/LoRA（整形式出力/ツール呼び出し強化）。
  - 例: `python scripts/train_lora.py --data data/sft/*.jsonl --base qwen2.5-7b --lora out/lora`
- `scripts/eval_lora.py`: LoRA適用モデルのA/B比較（ベース vs LoRA）。
  - 例: `python scripts/eval_lora.py --scenarios data/scenarios --models configs/ab.yaml`

---
本基本設計は、要件定義.mdの「ハードウェア別プロファイル」「Confidence Router」「整形式出力」「評価/セキュリティ強化」を設計へ具体化した。次工程では詳細設計としてデータクラス/例外/モジュール境界の定義と、最小プロト（M1）の実装に着手する。

## 18. ファイル/スクリプトの役割
- `scripts/run_server.py`: FastAPIサーバのブートストラップ。`configs/model.yaml`/`configs/security.yaml`を読み込み、Runner/Router/Validatorを初期化してエンドポイントを公開。
- `scripts/chat_cli.py`: ローカル対話CLI。ストリーミング応答の受信、整形式（JSON）検証、`runs/`へのログ保存を行う。
- `scripts/bench_eval.py`: ベンチシナリオ一括評価。ツール正確性/JSON妥当性/レイテンシ/トークン毎秒の集計とCSV出力。
- `scripts/adversarial_test.py`: Prompt injection/ノイズ/未定義関数誘導の耐性テスト。失敗種別と再試行を記録。
- `scripts/router_sweep.py`: Confidence閾値・温度・n-best等の探索。カスケード有無のKPI比較を生成。
- `scripts/replay_session.py`: JSONLセッションの再生による再現性確認（seed固定・差分比較）。
- `scripts/build_index.py`: 世界観/API仕様のベクタ索引（FAISS）を構築して`artifacts/index.faiss`へ保存。
- `scripts/gen_synthetic_actions.py`: 関数呼び出しの合成データ生成。構造妥当性の事後検証込みでJSONL出力。
- `scripts/validate_actions.py`: LLM出力`structured_actions`のJSON Schema/関数定義検証と危険度付与。
- `scripts/io_policy_check.py`: ツール引数のURL/パスをI/Oポリシ（SSRF/外部I/O）で静的検査。
- `scripts/measure_power.py`: レイテンシ/トークン毎秒とGPU電力を同時計測し、1トークン当たりコストを算出。
- `scripts/verify_artifacts.py`: モデル/トークナイザ/量子化重みのSHA256検証と由来ログ出力。
- `scripts/convert_quant.py`: 重みの量子化/形式変換（HF→GGUF、GPTQ/AWQメタ生成）ユーティリティ。
- `scripts/log_summary.py`: JSONLログからP50/P95・妥当性率・正確性の集計とレポート生成。
- `scripts/train_lora.py`: 小規模SFT/LoRA学習（整形式出力/ツール強化）。学習・検証・評価を一括実行。
- `scripts/eval_lora.py`: ベース vs LoRAのA/B評価と差分レポート生成。

- `configs/model.yaml`: モデル/ランナー/量子化/サンプリング/コンテキスト長/Router設定の中核コンフィグ。
- `configs/security.yaml`: I/Oポリシ（ネット/ファイル許可、許可ホスト、タイムアウト等）の定義。
- `configs/functions.json`: 利用可能な関数群（名前、説明、引数スキーマ、リスク）を定義するレジストリ。
- `configs/sweeps/router.yaml`: ルータ/サンプリングの探索グリッド定義（閾値、温度、n-best等）。
- `configs/artifacts.yaml`: モデル/辞書/量子化重み等のアーティファクトとSHA256のマニフェスト。

- `app/api/`: FastAPIルータ実装（`/chat`, `/propose_action`, `/schema/functions`）。
- `app/llm/`: ランナー（`llama_cpp`, `exllama_v2`, `transformers`）と`Confidence Router`の実装。
- `app/memory/`: 会話履歴・要約・RAG（ベクタ検索）モジュール。
- `app/tooling/`: FunctionRegistry、スキーマ検証、アクションビルダ（構造化出力の生成/修復）。
- `app/security/`: サンドボックス、I/Oポリシ適用、PII処理。
- `app/evaluator/`: メトリクス計算とシナリオ評価ロジック。
- `app/core/`: 設定ロード、ロギング、メトリクス収集、共通ユーティリティ。
- `app/prompts/`: システム/少数例/修復用プロンプトテンプレート群。

- `data/knowledge/`: 世界観・API仕様などのソース文書（Markdown/JSON）。
- `artifacts/index.faiss`: 構築済みベクタ索引（FAISS）。
- `runs/`: JSONL形式のセッション/評価/メトリクスログ出力先。
- `reports/`: 評価サマリ（CSV/PNG等）の出力先。
