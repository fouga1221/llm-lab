# 詳細設計書: オンラインゲームNPC自然会話用ローカルLLM

## 1. 目的・方針
- 目的: 基本設計に基づき、実装時に仕様が揺らがない粒度でクラス設計/関数設計/型定義を示す。実行スクリプトのUXも明確化する。
- 方針: 一貫性・疎結合・最小依存（標準ライブラリ優先、API層はFastAPI/Pydantic前提）。冗長処理や不要パッケージを避け、保守性・可読性を担保する。

## 2. モジュール全体像
- app/core: 設定/ロギング/メトリクス/共通ユーティリティ
- app/api: HTTPエンドポイント（/chat, /propose_action, /schema/functions）
- app/llm: ランナー（llama_cpp/exllama_v2/transformers）とConfidence Router
- app/memory: 会話履歴、要約、RAG（FAISS想定の抽象I/F）
- app/tooling: FunctionRegistry、JSONスキーマ検証、StructuredActions生成/修復
- app/security: I/Oポリシ、サンドボックス、出力検証
- app/evaluator: 指標計算、シナリオ評価
- app/prompts: システム/少数例/修復用テンプレート

## 3. 共通型定義（Python typing）
```python
from __future__ import annotations
from typing import Any, Dict, Iterable, List, Literal, Optional, Protocol, Tuple, TypedDict, Union
from dataclasses import dataclass

Role = Literal['system', 'user', 'assistant']

@dataclass
class Message:
    role: Role
    content: str

@dataclass
class GenerationParams:
    temperature: float = 0.6
    top_p: float = 0.9
    repetition_penalty: float = 1.0
    max_new_tokens: int = 512
    json_mode: bool = True  # JSON拘束の目安（実装側でGrammar適用）

class StreamChunk(TypedDict):
    text: str
    done: bool

class StructuredAction(TypedDict, total=False):
    function: str
    arguments: Dict[str, Any]
    confidence: float
    rationale: str
    risk: Literal['low', 'medium', 'high']

class StructuredActions(TypedDict):
    actions: List[StructuredAction]

@dataclass
class ModelInfo:
    model_id: str
    runner: Literal['llama_cpp', 'exllama_v2', 'transformers']
    context_length: int
    quantization: Optional[str] = None  # e.g., 'gptq-4bit', 'gguf-q4_k_m'

@dataclass
class RouteDecision:
    model: ModelInfo
    reason: str
    confidence: float
```

## 4. app/core
### 4.1 ConfigLoader
```python
class ConfigLoader:
    def __init__(self, model_path: str, security_path: str, functions_path: str) -> None: ...
    def load_model(self) -> Dict[str, Any]: ...  # YAML→dict
    def load_security(self) -> Dict[str, Any]: ...
    def load_functions(self) -> Dict[str, Any]: ...  # JSON→dict
```

### 4.2 Logger/Metrics
```python
class Logger:
    def __init__(self, level: str = 'INFO') -> None: ...
    def info(self, msg: str, **fields: Any) -> None: ...
    def error(self, msg: str, **fields: Any) -> None: ...

class Metrics:
    def start_timer(self, key: str) -> None: ...
    def stop_timer(self, key: str) -> float: ...  # elapsed ms
    def incr(self, key: str, value: float = 1.0) -> None: ...
```

## 5. app/llm
### 5.1 ランナーI/F
```python
class BaseRunner(Protocol):
    def generate(self, messages: List[Message], params: GenerationParams) -> str: ...
    def stream(self, messages: List[Message], params: GenerationParams) -> Iterable[StreamChunk]: ...
    def model_info(self) -> ModelInfo: ...
```

実装クラス（例）
- `LlamaCppRunner(BaseRunner)`
- `ExLlamaV2Runner(BaseRunner)`
- `TransformersRunner(BaseRunner)`

### 5.2 ConfidenceRouter
```python
class ConfidenceRouter:
    def __init__(self, primary: BaseRunner, fallback: Optional[BaseRunner], threshold: float = 0.78) -> None: ...

    def estimate_confidence(self, text: str, actions: StructuredActions, signals: Dict[str, Any]) -> float: ...

    def route_and_generate(
        self,
        messages: List[Message],
        params: GenerationParams,
        guard: 'JsonStreamGuard',
        self_check: 'SelfChecker'
    ) -> Tuple[str, StructuredActions, RouteDecision]: ...
```

## 6. app/memory
### 6.1 ConversationMemory
```python
class ConversationMemory:
    def __init__(self, max_turns: int = 8) -> None: ...
    def append(self, msg: Message) -> None: ...
    def summarize(self) -> str: ...  # 要約アルゴリズムは単純化（将来置換可能）
    def build_context(self) -> List[Message]: ...  # 最新K＋要約
```

### 6.2 VectorStore/RAG（抽象I/F）
```python
class VectorStore(Protocol):
    def add(self, doc_id: str, text: str, meta: Dict[str, Any]) -> None: ...
    def search(self, query: str, k: int = 5) -> List[Tuple[str, float, Dict[str, Any]]]: ...
```

## 7. app/tooling
### 7.1 FunctionRegistry/Spec
```python
from typing import NamedTuple

class FunctionSpec(NamedTuple):
    name: str
    description: str
    schema: Dict[str, Any]  # JSON Schema for parameters
    risk: Literal['low', 'medium', 'high']

class FunctionRegistry:
    def __init__(self, specs: List[FunctionSpec]) -> None: ...
    def get(self, name: str) -> Optional[FunctionSpec]: ...
    def names(self) -> List[str]: ...
```

### 7.2 JSONスキーマ検証/整形式ガード
```python
class JsonSchemaValidator:
    def __init__(self, actions_schema: Dict[str, Any]) -> None: ...
    def validate_actions(self, obj: Dict[str, Any]) -> Tuple[bool, List[str]]: ...

class JsonStreamGuard:
    def __init__(self, schema: Dict[str, Any]) -> None: ...
    def feed(self, chunk: str) -> Tuple[Optional[StructuredActions], Optional[str]]: ...  # (完成時のactions, エラー)
    def reset(self) -> None: ...
```

### 7.3 ActionBuilder/SelfChecker
```python
class ActionBuilder:
    def __init__(self, registry: FunctionRegistry) -> None: ...
    def extract(self, text: str) -> StructuredActions: ...  # 後段でJsonSchemaValidatorが検証

class SelfChecker:
    def check(self, reply: str, actions: StructuredActions, registry: FunctionRegistry) -> Dict[str, Any]: ...
```

## 8. app/security
```python
class IOPolicy:
    def __init__(self, allow_network: bool, allowed_hosts: List[str], allowed_paths: List[str] | None = None) -> None: ...
    def validate_url(self, url: str) -> Tuple[bool, Optional[str]]: ...

class Sandbox:
    def dry_run(self, code: str) -> Tuple[bool, str]: ...  # 静的検査（実行はしない）

class ActionValidator:
    def __init__(self, schema_validator: JsonSchemaValidator, io_policy: IOPolicy, registry: FunctionRegistry) -> None: ...
    def validate(self, actions: StructuredActions) -> Tuple[bool, List[str]]: ...
```

## 9. app/api（Pydanticモデルの概念）
```python
from pydantic import BaseModel

class ChatRequest(BaseModel):
    session_id: str
    input: str
    state: Optional[Dict[str, Any]] = None
    options: Optional[Dict[str, Any]] = None

class ChatResponse(BaseModel):
    reply: str
    structured_actions: StructuredActions
    meta: Dict[str, Any]
```

エンドポイントの流れ
1) 入力受理→メモリ/要約→RAG文脈追加→プロンプト組立
2) Router経由で推論（ストリーミング）：JsonStreamGuardで逐次検証
3) SelfCheckerで信号抽出→Confidence算出→必要ならフォールバック
4) ActionValidatorで最終検証→レスポンス返却

## 10. app/evaluator
```python
class MetricsCalculator:
    def tool_accuracy(self, truth: List[StructuredAction], pred: List[StructuredAction]) -> float: ...
    def json_valid_rate(self, logs: Iterable[Dict[str, Any]]) -> float: ...
    def latency_stats(self, values: List[float]) -> Dict[str, float]: ...  # p50/p95 等

class ScenarioRunner:
    def run(self, scenarios_path: str, client: 'ApiClient') -> Dict[str, Any]: ...
```

## 11. エラー/例外設計
- 共通例外: `ConfigurationError`, `ValidationError`, `InferenceError`, `RoutingError`。
- 例外はAPI層でHTTP 4xx/5xxに正規化。ログは構造化（JSON Lines）。

## 12. ロギング/メトリクス
- 重要フィールド: `session_id`, `model_id`, `quantization`, `seed`, `latency_ms`, `toks_per_sec_prefill`, `toks_per_sec_decode`, `json_valid`, `tool_exact_match`。
- 出力先: `runs/*.jsonl`。ベンチはCSV/PNG併用可。

## 13. 設定ファイルスキーマ（要点）
- configs/model.yaml
```yaml
runner: exllama_v2              # enum: llama_cpp|exllama_v2|transformers
model_id: qwen2.5-7b-gptq-4bit-exl2
context_length: 32768
sampling:
  temperature: 0.6
  top_p: 0.9
router:
  primary: qwen2.5-7b-gptq-4bit-exl2
  fallback: llama-3.1-8b-instruct-gguf-q4_k_m
  confidence_threshold: 0.78
```
- configs/security.yaml
```yaml
allow_network: false
allowed_hosts: []
allowed_paths: []
timeouts:
  request_ms: 10000
```
- configs/functions.json（抜粋）
```json
{ "functions": [{
  "name": "npc_follow_player",
  "description": "NPCがプレイヤーの後を追う",
  "parameters": {"type": "object", "required": ["npc_id","player_id"], "properties": {"npc_id": {"type": "string"}, "player_id": {"type": "string"}, "speed": {"type": "string", "enum": ["walk","run"], "default": "walk"}}},
  "risk": "low"
}]}
```

## 14. 実行スクリプト設計（UX/オプション）
共通: すべて`--config`でモデル設定、`--security`でI/Oポリシ、`--functions`で関数定義を上書き可能。`--log`で出力先指定（デフォルト: `runs/`）。

- scripts/run_server.py
  - 目的: APIサーバ起動（/chat, /propose_action, /schema/functions）。
  - 主要オプション:
    - `--host` (str, default `0.0.0.0`), `--port` (int, 8000)
    - `--config` (path), `--security` (path), `--functions` (path)
    - `--workers` (int, 1), `--reload` (bool)
  - UX: 起動時にモデル/量子化/Router構成をログに出力。

- scripts/chat_cli.py
  - 目的: ローカル対話（ストリーミング、構造出力の妥当性チェック）。
  - 主要オプション:
    - `--session` (str), `--system` (path: persona.md), `--functions` (path)
    - `--temperature` (float), `--top_p` (float), `--max_new_tokens` (int)
    - `--json` (bool: JSON拘束強制), `--save` (path: runs/*.jsonl)
  - UX: プロンプトとactionsを2段で表示。JSONエラー時は自動リトライ回数を明示。

- scripts/bench_eval.py
  - 目的: KPI一括評価。
  - オプション: `--scenarios` (glob), `--out` (csv), `--p95` (bool), `--retries` (int)
  - UX: 実行後に表形式のサマリを標準出力に表示。

- scripts/adversarial_test.py
  - 目的: Prompt injection/ノイズ/未定義関数誘導の耐性評価。
  - オプション: `--cases` (glob), `--retries` (int), `--report` (path)

- scripts/router_sweep.py
  - 目的: 閾値/温度/n-best探索とカスケード比較。
  - オプション: `--grid` (yaml), `--out` (csv), `--plot` (png|none)

- scripts/replay_session.py
  - 目的: JSONLセッション再生（再現性確認）。
  - オプション: `--log` (path), `--seed` (int)

- scripts/build_index.py
  - 目的: 世界観/API仕様のベクタ索引構築。
  - オプション: `--src` (dir), `--out` (path), `--dim` (int), `--k` (int)

- scripts/gen_synthetic_actions.py
  - 目的: 合成データ生成（few-shot+ルール）。
  - オプション: `--functions` (path), `--count` (int), `--out` (jsonl)

- scripts/validate_actions.py
  - 目的: structured_actionsのスキーマ/関数定義検証。
  - オプション: `--in` (jsonl), `--functions` (path), `--report` (path)

- scripts/io_policy_check.py
  - 目的: ツール引数のURL/パスのI/Oポリシ検査。
  - オプション: `--in` (jsonl), `--policy` (yaml)

- scripts/measure_power.py
  - 目的: レイテンシ/トークン毎秒/電力の計測。
  - オプション: `--duration` (sec), `--model` (str), `--out` (csv)

- scripts/verify_artifacts.py
  - 目的: 重み/トークナイザ/量子化重みのSHA256検証。
  - オプション: `--manifest` (yaml), `--strict` (bool)

- scripts/convert_quant.py
  - 目的: 量子化/形式変換ユーティリティ（HF→GGUF等）。
  - オプション: `--src` (path), `--to` (enum: gguf|gptq|awq), `--bits` (int), `--out` (path)

- scripts/log_summary.py
  - 目的: ログ集計。
  - オプション: `--logs` (glob), `--out` (csv), `--groupby` (model|quant|run)

- scripts/train_lora.py
  - 目的: 小規模SFT/LoRA学習。
  - オプション: `--data` (glob), `--base` (model id), `--lora` (out dir), `--epochs` (int), `--lr` (float)

- scripts/eval_lora.py
  - 目的: LoRA適用モデルのA/B評価。
  - オプション: `--scenarios` (dir), `--models` (yaml)

## 15. 非機能要求への適合
- レイテンシ: 7B-4bitを既定のprimary、ストリーミング＋インクリメンタル検証でP95短縮。
- コスト: 量子化前提、KVキャッシュ、ExLlamaV2/GGUF選択で効率化。
- 安全性: I/Oポリシ＋スキーマ拘束、生成コードは非実行。

## 16. 保守性/拡張
- ランナー差し替え（Protocol）、RAG実装差し替え（VectorStore）、スキーマ/関数の拡張容易。
- 設定駆動（YAML/JSON）、ログ/メトリクスの標準化で運用一貫性を確保。

